# Requirements Document

## Introduction
Criticエージェントは、autonomous-ideation-agentシステムにおいて、Ideatorエージェントが生成した5つのビジネスアイデアを評価し、最も有望なアイデアを選定する重要な判断機能を担います。市場規模（50点満点）と三菱地所とのシナジー（50点満点）という2つの評価軸を用いて、各アイデアを定量的に評価し、合計100点満点で最高得点のアイデアを選定します。

## Requirements

### Requirement 1: アイデア評価機能
**User Story:** 新事業担当者として、生成された5つのビジネスアイデアを客観的な基準で評価し、最も有望なアイデアを選定したい。これにより、限られたリソースを最も価値のある事業案に集中できる。

#### Acceptance Criteria

1. WHEN Ideatorエージェントから5つのビジネスアイデアを受け取った THEN Criticエージェント SHALL 各アイデアに対して市場規模評価とシナジー評価を実行する
2. WHEN 市場規模を評価する際 THEN システム SHALL estimatedRevenue、marketOpportunity、市場成長性を総合的に分析して0〜50点のスコアを算出する
3. WHEN 三菱地所とのシナジーを評価する際 THEN システム SHALL 以下の多段階評価プロセスを実行して0〜50点のスコアを算出する：
   - Stage 1: ケイパビリティマッピング（事業に必要な能力と三菱地所の保有能力の照合）
   - Stage 2: シナジーシナリオ生成（「なぜ三菱地所が圧倒的に有利か」の具体的ストーリー構築）
   - Stage 3: 客観的検証（シナリオの納得性・実現可能性の評価）
4. IF アイデアの推定営業利益が10億円以上 THEN システム SHALL 市場規模スコアに高い重みづけを適用する
5. WHILE 評価処理を実行中 THE SYSTEM SHALL 各評価項目の根拠と詳細な分析結果を記録する
6. WHEN すべてのアイデアの評価が完了した THEN システム SHALL 合計スコア（市場規模＋シナジー）が最も高いアイデアを最優秀案として選定する

### Requirement 2: LLM統合による高度な評価
**User Story:** AIシステム管理者として、LLMの能力を活用して文脈を考慮した深い評価を実現し、人間の評価者に近い判断品質を達成したい。

#### Acceptance Criteria

1. WHEN 評価プロンプトを構築する際 THEN システム SHALL 各アイデアの詳細情報、市場調査結果、三菱地所の事業ポートフォリオ・ネットワーク資産・コアケイパビリティ情報を含める
2. IF LLM APIの呼び出しが失敗した THEN システム SHALL 最大2回まで指数バックオフでリトライを実行する
3. WHEN LLMから評価結果を受け取った THEN システム SHALL JSON形式で構造化されたスコアと評価理由を抽出する
4. WHERE Edge Functions環境で実行される場合 THE SYSTEM SHALL fs依存を使用せずメモリベースで処理を完了する
5. WHEN temperature設定を行う際 THEN システム SHALL 0.3〜0.5の範囲で設定し、評価の一貫性を保つ

### Requirement 3: 評価データの構造化と保存
**User Story:** データアナリストとして、評価結果を詳細に分析し、将来の改善に活用できるよう、すべての評価データを構造化された形式で保存したい。

#### Acceptance Criteria

1. WHEN 評価結果を生成する際 THEN システム SHALL 以下の情報を含むCriticOutput型のオブジェクトを作成する：選定されたアイデア、全アイデアのスコア詳細、評価根拠、タイムスタンプ
2. IF データベース接続が利用可能な場合 THEN システム SHALL 評価結果をcritic_evaluationsテーブルに保存する
3. WHEN 評価スコアを記録する際 THEN システム SHALL 市場規模の内訳（市場サイズ、成長性、収益性）とシナジーの内訳（リソース活用、ブランド貢献、戦略的価値）を個別に保存する
4. WHERE ログ記録が有効な場合 THE SYSTEM SHALL EdgeLoggerを使用して評価プロセスの詳細をログに記録する

### Requirement 4: 評価ロジックのカスタマイズ性
**User Story:** ビジネス戦略担当者として、事業環境の変化に応じて評価基準の重みづけを調整し、戦略的優先順位を反映させたい。

#### Acceptance Criteria

1. WHEN Criticエージェントを初期化する際 THEN システム SHALL 評価重みづけ設定（marketWeight、synergyWeight）を受け入れる
2. IF カスタム評価基準が提供された場合 THEN システム SHALL デフォルトの50:50配分を上書きして指定された配分を適用する
3. WHEN 三菱地所固有の評価基準を適用する際 THEN システム SHALL 以下の要素を詳細に評価する：
   - 不動産開発力（設計・PM・用地取得）の活用度
   - 不動産運営・管理力（FM・テナントリレーション）の活用度
   - 金融・投資力（資金調達・ファンド組成）の活用度
   - 事業創造・イノベーション力（DX・新規事業）の活用度
   - 丸の内テナント企業群（大手企業ネットワーク）との連携可能性
   - 三菱グループ（商事・UFJ・重工等）とのシナジー創出力
4. WHERE 特定の業界にフォーカスする場合 THE SYSTEM SHALL 業界特化型の評価パラメータを追加で適用する

### Requirement 5: パフォーマンスとスケーラビリティ
**User Story:** システム運用者として、複数のアイディエーションセッションを並行処理し、10分以内の全体処理時間を維持したい。

#### Acceptance Criteria

1. WHEN 5つのアイデアを評価する際 THEN システム SHALL 30秒以内に全評価を完了する
2. IF 複数の評価リクエストが同時に発生した場合 THEN システム SHALL 最大5つまで並行処理を実行する
3. WHILE メモリ使用量を監視する際 THE SYSTEM SHALL 512MB以下のメモリ使用量を維持する
4. WHEN トークン使用量を計測する際 THEN システム SHALL 評価あたり2000トークン以下に抑える
5. WHERE キャッシュが有効な場合 THE SYSTEM SHALL 同一アイデアの再評価時にキャッシュされた結果を返す

### Requirement 6: エラーハンドリングと信頼性
**User Story:** システム管理者として、評価プロセスが確実に完了し、部分的な失敗でも可能な限り結果を提供できるようにしたい。

#### Acceptance Criteria

1. IF 5つのアイデアのうち一部の評価が失敗した場合 THEN システム SHALL 成功した評価結果のみで最優秀案を選定する
2. WHEN 評価スコアが異常値（0未満または各項目の満点超過）を示した場合 THEN システム SHALL エラーをログに記録し、デフォルトスコアを適用する
3. IF すべてのアイデアの評価が失敗した場合 THEN システム SHALL CriticErrorを投げ、詳細なエラー情報を含める
4. WHEN タイムアウトが発生した場合 THEN システム SHALL 30秒のタイムアウト後に処理を中断し、部分的な結果を返す
5. WHERE リトライが必要な場合 THE SYSTEM SHALL 指数バックオフ（初回1秒、最大10秒）でリトライを実行する

### Requirement 7: 他エージェントとの統合
**User Story:** システムアーキテクトとして、Criticエージェントが他のエージェントとシームレスに連携し、autonomous-ideation-agentの一部として動作することを保証したい。

#### Acceptance Criteria

1. WHEN IdeatorエージェントからIdeatorOutputを受け取った際 THEN Criticエージェント SHALL BusinessIdea[]配列を正しく解析し処理する
2. WHEN 評価が完了した際 THEN システム SHALL 選定されたアイデアをAnalystエージェントが処理可能な形式で出力する
3. IF LangGraphオーケストレーションで実行される場合 THEN システム SHALL ステート管理に従い、適切なタイミングで実行される
4. WHERE エージェント間通信が必要な場合 THE SYSTEM SHALL 標準化されたAgentMessageインターフェースを使用する
5. WHEN BaseAgentクラスを継承する際 THEN システム SHALL execute()メソッドを実装し、共通のエラーハンドリングを継承する

### Requirement 8: テストとバリデーション
**User Story:** QAエンジニアとして、Criticエージェントの評価ロジックが正確で一貫性があることを検証し、品質を保証したい。

#### Acceptance Criteria

1. WHEN ユニットテストを実行する際 THEN システム SHALL モックLLMを使用して評価ロジックを検証する
2. IF 統合テストを実行する場合 THEN システム SHALL 実際のIdeatorOutput形式のテストデータで動作を確認する
3. WHEN 評価の一貫性をテストする際 THEN システム SHALL 同一入力に対して±5点以内の評価差に収まることを検証する
4. WHERE パフォーマンステストを実行する場合 THE SYSTEM SHALL 100回の評価を連続実行し、メモリリークがないことを確認する
5. WHEN バリデーションを実行する際 THEN システム SHALL Zod schemaを使用して入出力データの型安全性を保証する

### Requirement 9: 三菱地所ケイパビリティ活用の深層評価
**User Story:** ビジネス戦略担当者として、三菱地所の持つ独自の強みを最大限活用できるアイデアを確実に選定し、競合他社では実現困難な事業優位性を確立したい。

#### Acceptance Criteria

1. WHEN シナジー評価を実行する際 THEN システム SHALL 以下の3段階評価プロセスを実行する：
   - Stage 1: 必要ケイパビリティの特定（アイデア実現に必要な能力・資産のリストアップ）
   - Stage 2: ケイパビリティマッチング（三菱地所の4大ケイパビリティとの照合）
   - Stage 3: 競合優位性の検証（他社では模倣困難な要素の特定）

2. WHEN シナジーシナリオを生成する際 THEN システム SHALL 以下の観点で具体的なストーリーを構築する：
   - 丸の内30棟・400万㎡の活用方法
   - 大手企業テナント3000社との連携方法
   - 三菱グループ各社（商事・UFJ・重工等）との協業方法
   - 全国8箇所のアウトレットモール活用方法
   - 累計8万戸のパークハウス居住者ネットワーク活用方法

3. IF シナジーシナリオが生成された場合 THEN システム SHALL 以下の基準で客観的な納得性を評価する：
   - 論理的整合性（因果関係の明確性）
   - 実現可能性（リソース・時間軸の現実性）
   - 独自性（他社では実現困難な理由の明確化）
   - 規模感（活用する資産・ネットワークの規模）

4. WHEN ケイパビリティ強度を評価する際 THEN システム SHALL 以下のスコアリングを適用する：
   - 不動産開発力活用（strength_level: 10）→ 最大15点
   - 不動産運営・管理力活用（strength_level: 9）→ 最大13点
   - 金融・投資力活用（strength_level: 9）→ 最大13点
   - 事業創造・イノベーション力活用（strength_level: 7）→ 最大9点

5. WHERE 複数のケイパビリティが組み合わされる場合 THE SYSTEM SHALL シナジー乗数効果（1.2〜1.5倍）を適用する